(function(){L.Control.Search=L.Control.extend({includes:L.Mixin.Events,options:{wrapper:"",url:"",jsonpParam:null,layer:null,callData:null,propertyName:"title",propertyLoc:"loc",callTip:null,filterJSON:null,minLength:1,initial:true,autoType:true,delayType:400,tooltipLimit:-1,tipAutoSubmit:true,autoResize:true,autoCollapse:false,autoCollapseTime:1200,animateLocation:true,circleLocation:true,markerLocation:false,zoom:null,text:"Search...",textCancel:"Cancel",textErr:"Location not found",position:"topleft"},initialize:function(e){L.Util.setOptions(this,e||{});this._inputMinSize=this.options.text?this.options.text.length:10;this._layer=this.options.layer||new L.LayerGroup;this._filterJSON=this.options.filterJSON||this._defaultFilterJSON;this._autoTypeTmp=this.options.autoType;this._countertips=0;this._recordsCache={}},onAdd:function(t){this._map=t;this._container=L.DomUtil.create("div","leaflet-control-search");this._input=this._createInput(this.options.text,"search-input");this._tooltip=this._createTooltip("search-tooltip");this._cancel=this._createCancel(this.options.textCancel,"search-cancel");this._button=this._createButton(this.options.text,"search-button");this._alert=this._createAlert("search-alert");if(this.options.circleLocation||this.options.markerLocation)this._markerLoc=new e([0,0],{marker:this.options.markerLocation});this.setLayer(this._layer);t.on({resize:this._handleAutoresize},this);return this._container},addTo:function(e){if(this.options.wrapper){this._container=this.onAdd(e);this._wrapper=L.DomUtil.get(this.options.wrapper);this._wrapper.style.position="relative";this._wrapper.appendChild(this._container)}else L.Control.prototype.addTo.call(this,e);return this},onRemove:function(e){this._recordsCache={}},_getPath:function(e,t){var n=t.split("."),r=n.pop(),i=n.length,s=n[0],o=1;if(i>0)while((e=e[s])&&o<i)s=n[o++];if(e)return e[r]},setLayer:function(e){this._layer=e;this._layer.addTo(this._map);if(this._markerLoc)this._layer.addLayer(this._markerLoc);return this},showAlert:function(e){e=e||this.options.textErr;this._alert.style.display="block";this._alert.innerHTML=e;clearTimeout(this.timerAlert);var t=this;this.timerAlert=setTimeout(function(){t.hideAlert()},this.options.autoCollapseTime);return this},hideAlert:function(){this._alert.style.display="none";return this},cancel:function(){this._input.value="";this._handleKeypress({keyCode:8});this._input.size=this._inputMinSize;this._input.focus();this._cancel.style.display="none";return this},expand:function(){this._input.style.display="block";L.DomUtil.addClass(this._container,"search-exp");this._input.focus();this._map.on("dragstart",this.collapse,this);return this},collapse:function(){this._hideTooltip();this.cancel();this._alert.style.display="none";this._input.style.display="none";this._input.blur();this._cancel.style.display="none";L.DomUtil.removeClass(this._container,"search-exp");this._map.off("dragstart",this.collapse,this);this.fire("search_collapsed");return this},collapseDelayed:function(){if(!this.options.autoCollapse)return this;var e=this;clearTimeout(this.timerCollapse);this.timerCollapse=setTimeout(function(){e.collapse()},this.options.autoCollapseTime);return this},collapseDelayedStop:function(){clearTimeout(this.timerCollapse);return this},_createAlert:function(e){var t=L.DomUtil.create("div",e,this._container);t.style.display="none";L.DomEvent.on(t,"click",L.DomEvent.stop,this).on(t,"click",this.hideAlert,this);return t},_createInput:function(e,t){var n=L.DomUtil.create("input",t,this._container);n.type="text";n.size=this._inputMinSize;n.value="";n.autocomplete="off";n.placeholder=e;n.style.display="none";L.DomEvent.disableClickPropagation(n).on(n,"keyup",this._handleKeypress,this).on(n,"keydown",this._handleAutoresize,this).on(n,"blur",this.collapseDelayed,this).on(n,"focus",this.collapseDelayedStop,this);return n},_createCancel:function(e,t){var n=L.DomUtil.create("a",t,this._container);n.href="#";n.title=e;n.style.display="none";n.innerHTML="<span>&otimes;</span>";L.DomEvent.on(n,"click",L.DomEvent.stop,this).on(n,"click",this.cancel,this);return n},_createButton:function(e,t){var n=L.DomUtil.create("a",t,this._container);n.href="#";n.title=e;L.DomEvent.on(n,"click",L.DomEvent.stop,this).on(n,"click",this._handleSubmit,this).on(n,"focus",this.collapseDelayedStop,this).on(n,"blur",this.collapseDelayed,this);return n},_createTooltip:function(e){var t=L.DomUtil.create("div",e,this._container);t.style.display="none";var n=this;L.DomEvent.disableClickPropagation(t).on(t,"blur",this.collapseDelayed,this).on(t,"mousewheel",function(e){n.collapseDelayedStop();L.DomEvent.stopPropagation(e)},this).on(t,"mouseover",function(e){n.collapseDelayedStop()},this);return t},_createTip:function(e,t){var n;if(this.options.callTip){n=this.options.callTip(e,t);if(typeof n==="string"){var r=L.DomUtil.create("div");r.innerHTML=n;n=r.firstChild}}else{n=L.DomUtil.create("a","");n.href="#";n.innerHTML=e}L.DomUtil.addClass(n,"search-tip");n._text=e;L.DomEvent.disableClickPropagation(n).on(n,"click",L.DomEvent.stop,this).on(n,"click",function(t){this._input.value=e;this._handleAutoresize();this._input.focus();this._hideTooltip();if(this.options.tipAutoSubmit)this._handleSubmit()},this);return n},_filterRecords:function(e){var t=new RegExp("^[.]$|[[]|()*]","g"),n,r,i={};e=e.replace(t,"");n=this.options.initial?"^":"";r=new RegExp(n+e,"i");for(var s in this._recordsCache)if(r.test(s))i[s]=this._recordsCache[s];return i},showTooltip:function(){var e,t;this._countertips=0;if(this.options.layer)e=this._filterRecords(this._input.value);else e=this._recordsCache;this._tooltip.innerHTML="";this._tooltip.currentSelection=-1;for(var n in e){if(++this._countertips==this.options.tooltipLimit)break;t=this._createTip(n,e[n]);this._tooltip.appendChild(t)}if(this._countertips>0){this._tooltip.style.display="block";if(this._autoTypeTmp)this._autoType();this._autoTypeTmp=this.options.autoType}else this._hideTooltip();this._tooltip.scrollTop=0;return this._countertips},_hideTooltip:function(){this._tooltip.style.display="none";this._tooltip.innerHTML="";return 0},_defaultFilterJSON:function(e){var t={},n,r=this.options.propertyName,i=this.options.propertyLoc;if(L.Util.isArray(i))for(n in e)t[this._getPath(e[n],r)]=L.latLng(e[n][i[0]],e[n][i[1]]);else for(n in e)t[this._getPath(e[n],r)]=L.latLng(this._getPath(e[n],i));return t},_recordsFromJsonp:function(e,t){var n=this;L.Control.Search.callJsonp=function(e){var r=n._filterJSON(e);t(r)};var r=L.DomUtil.create("script","search-jsonp",document.getElementsByTagName("body")[0]),i=L.Util.template(this.options.url+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:e});r.type="text/javascript";r.src=i;return this},_recordsFromAjax:function(e,t){if(window.XMLHttpRequest===undefined){window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(t){throw new Error("XMLHttpRequest is not supported")}}}}var n=new XMLHttpRequest,r=L.Util.template(this.options.url,{s:e}),i={};n.open("GET",r);var s=this;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){i=JSON.parse(n.responseText);var e=s._filterJSON(i);t(e)}};n.send();return this},_recordsFromLayer:function(){var t=this,n={},r=this.options.propertyName,i;this._layer.eachLayer(function(s){if(s instanceof e)return;if(s instanceof L.Marker){if(t._getPath(s.options,r)){i=s.getLatLng();i.layer=s;n[t._getPath(s.options,r)]=i}else if(t._getPath(s.feature.properties,r)){i=s.getLatLng();i.layer=s;n[t._getPath(s.feature.properties,r)]=i}else{console.log("propertyName '"+r+"' not found in marker",s)}}else if(s.hasOwnProperty("feature")){if(s.feature.properties.hasOwnProperty(r)){i=s.getBounds().getCenter();i.layer=s;n[s.feature.properties[r]]=i}else console.log("propertyName '"+r+"' not found in feature",s)}},this);return n},_autoType:function(){var e=this._input.value.length,t=this._tooltip.firstChild._text,n=t.length;if(t.indexOf(this._input.value)===0){this._input.value=t;this._handleAutoresize();if(this._input.createTextRange){var r=this._input.createTextRange();r.collapse(true);r.moveStart("character",e);r.moveEnd("character",n);r.select()}else if(this._input.setSelectionRange){this._input.setSelectionRange(e,n)}else if(this._input.selectionStart){this._input.selectionStart=e;this._input.selectionEnd=n}}},_hideAutoType:function(){var e;if((e=this._input.selection)&&e.empty){e.empty()}else if(this._input.createTextRange){e=this._input.createTextRange();e.collapse(true);var t=this._input.value.length;e.moveStart("character",t);e.moveEnd("character",t);e.select()}else{if(this._input.getSelection){this._input.getSelection().removeAllRanges()}this._input.selectionStart=this._input.selectionEnd}},_handleKeypress:function(e){switch(e.keyCode){case 27:this.collapse();break;case 13:if(this._countertips==1)this._handleArrowSelect(1);this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 37:case 39:case 16:case 17:break;case 8:case 46:this._autoTypeTmp=false;break;default:if(this._input.value.length)this._cancel.style.display="block";else this._cancel.style.display="none";if(this._input.value.length>=this.options.minLength){var t=this;clearTimeout(this.timerKeypress);this.timerKeypress=setTimeout(function(){t._fillRecordsCache()},this.options.delayType)}else this._hideTooltip()}},_fillRecordsCache:function(){var e=this._input.value,t;L.DomUtil.addClass(this._container,"search-load");if(this.options.callData){t=this;this.options.callData(e,function(e){t._recordsCache=t._filterJSON(e);t.showTooltip();L.DomUtil.removeClass(t._container,"search-load")})}else if(this.options.url){if(this.options.jsonpParam){t=this;this._recordsFromJsonp(e,function(e){t._recordsCache=e;t.showTooltip();L.DomUtil.removeClass(t._container,"search-load")})}else{t=this;this._recordsFromAjax(e,function(e){t._recordsCache=e;t.showTooltip();L.DomUtil.removeClass(t._container,"search-load")})}}else if(this.options.layer){this._recordsCache=this._recordsFromLayer();this.showTooltip();L.DomUtil.removeClass(this._container,"search-load")}},_handleAutoresize:function(){if(this._input.style.maxWidth!=this._map._container.offsetWidth)this._input.style.maxWidth=L.DomUtil.getStyle(this._map._container,"width");if(this.options.autoResize&&this._container.offsetWidth+45<this._map._container.offsetWidth)this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length},_handleArrowSelect:function(e){var t=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<t.length;i++)L.DomUtil.removeClass(t[i],"search-tip-select");if(e==1&&this._tooltip.currentSelection>=t.length-1){L.DomUtil.addClass(t[this._tooltip.currentSelection],"search-tip-select")}else if(e==-1&&this._tooltip.currentSelection<=0){this._tooltip.currentSelection=-1}else if(this._tooltip.style.display!="none"){this._tooltip.currentSelection+=e;L.DomUtil.addClass(t[this._tooltip.currentSelection],"search-tip-select");this._input.value=t[this._tooltip.currentSelection]._text;var n=t[this._tooltip.currentSelection].offsetTop;if(n+t[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight){this._tooltip.scrollTop=n-this._tooltip.clientHeight+t[this._tooltip.currentSelection].clientHeight}else if(n<=this._tooltip.scrollTop){this._tooltip.scrollTop=n}}},_handleSubmit:function(){this._hideAutoType();this.hideAlert();this._hideTooltip();if(this._input.style.display=="none")this.expand();else{if(this._input.value==="")this.collapse();else{var e=this._getLocation(this._input.value);if(e===false)this.showAlert();else{this.showLocation(e,this._input.value);this.fire("search_locationfound",{latlng:e,text:this._input.value,layer:e.layer?e.layer:null})}}}},_getLocation:function(e){if(this._recordsCache.hasOwnProperty(e))return this._recordsCache[e];else return false},showLocation:function(e,t){if(this.options.zoom)this._map.setView(e,this.options.zoom);else this._map.panTo(e);if(this._markerLoc){this._markerLoc.setLatLng(e);this._markerLoc.setTitle(t);this._markerLoc.show();if(this.options.animateLocation)this._markerLoc.animate()}if(this.options.autoCollapse)this.collapse();return this}});var e=L.Marker.extend({includes:L.Mixin.Events,options:{radius:10,weight:3,color:"#e03",stroke:true,fill:false,title:"",marker:false},initialize:function(e,t){L.setOptions(this,t);L.Marker.prototype.initialize.call(this,e,t);this._circleLoc=new L.CircleMarker(e,this.options)},onAdd:function(e){L.Marker.prototype.onAdd.call(this,e);e.addLayer(this._circleLoc);this.hide()},onRemove:function(e){L.Marker.prototype.onRemove.call(this,e);e.removeLayer(this._circleLoc)},setLatLng:function(e){L.Marker.prototype.setLatLng.call(this,e);this._circleLoc.setLatLng(e);return this},setTitle:function(e){e=e||"";this.options.title=e;if(this._icon)this._icon.title=e;return this},show:function(){if(this.options.marker){if(this._icon)this._icon.style.display="block";if(this._shadow)this._shadow.style.display="block"}if(this._circleLoc){this._circleLoc.setStyle({fill:this.options.fill,stroke:this.options.stroke})}return this},hide:function(){if(this._icon)this._icon.style.display="none";if(this._shadow)this._shadow.style.display="none";if(this._circleLoc)this._circleLoc.setStyle({fill:false,stroke:false});return this},animate:function(){var e=this._circleLoc,t=200,n=10,r=parseInt(e._radius/n),i=this.options.radius,s=e._radius*2.5,o=0;e._timerAnimLoc=setInterval(function(){o+=.5;r+=o;s-=r;e.setRadius(s);if(s<i){clearInterval(e._timerAnimLoc);e.setRadius(i)}},t);return this}});L.Map.addInitHook(function(){if(this.options.searchControl){this.searchControl=L.control.search(this.options.searchControl);this.addControl(this.searchControl)}});L.control.search=function(e){return new L.Control.Search(e)}}).call(this)